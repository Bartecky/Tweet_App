{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <title>{% block title %}Twitter app{% endblock %}</title>

    <!-- Bootstrap -->
    <link href="{% static 'static/css/bootstrap.min.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>
        .red-color {
            color: red;
        }

        .grey-color {
            color: grey;
        }
    </style>
</head>
<body>
{% include 'navbar.html' %}

<div class="container">
    {% block content %}
    {% endblock %}
</div>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script>
    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function loadTweetContainer(tweetContainerId) {
        var query = getParameterByName('q');
        var tweetList = [];
        var nextTweetUrl;
        var tweetContainer;
        if (tweetContainerId) {
            tweetContainer = $('#' + tweetContainerId)
        } else {
            tweetContainer = $('#tweet-container');
        }
        var initialUrl = tweetContainer.attr('data-url') || '/api/tweet/';


        $(document.body).on('click', '.tweet-like', function (e) {
            e.preventDefault();
            var this_ = $(this);
            var tweetId = this_.attr('data-id');
            var likedUrl = '/api/tweet/' + tweetId + '/like/';
            {#this_.text('Liked')#}
            $.ajax({
                method: 'GET',
                url: likedUrl,
                success: function (data) {
                    if (data.liked) {
                        this_.text('Liked')
                    } else {
                        this_.text('Unliked')
                    }
                },
                error: function (data) {
                    console.log('Error');
                    console.log('data');
                                    }
            })

        });

        $(document.body).on('click', '.retweetBtn', function (e) {
            var url = '/api' + $(this).attr('href');
            e.preventDefault();
            console.log('Clicked!');
            $.ajax({
                method: 'GET',
                url: url,
                success: function (data) {
                    console.log(data);
                    if (initialUrl == '/api/tweet/') {
                        attachTweet(data, true, true);
                        updateHashLinks();
                    }

                },
                error: function (data) {
                    console.log('Error');
                    console.log(data)
                }
            })
        });

        function updateHashLinks() {
            $('.media-body').each(function (data) {
                var hashtagRegex = /(^|\s)#([\w\d-]+)/g;
                var usernameRegex = /(^|\s)@([\w\d-]+)/g;
                var currentHtml = $(this).html();
                var newText;
                newText = currentHtml.replace(hashtagRegex, '$1<a href="/tags/$2/">#$2</a>');
                newText = newText.replace(usernameRegex, '$1@<a href="/$2/">$2</a>');
                $(this).html(newText);
            })
        }

        function attachTweet(tweetValue, prepend, retweet) {
            var tweetContent = tweetValue.content;
            var dateDisplay = tweetValue.date_display;
            var tweetUser = tweetValue.user;
            var tweetFormattedHtml;
            if (retweet && tweetValue.parent) {
                // retweet
                var mainTweet = tweetValue.parent;
                tweetFormattedHtml = "<div class=\"media\"><div class=\"media-body\"><span class='grey-color'>Retweet via " + tweetUser.username
                    + " on " + dateDisplay + "</span><br>" + mainTweet.content + "<br> via <a href='" + mainTweet.user.url
                    + "'>" + mainTweet.user.username + " </a> | " + mainTweet.date_display + " | " + "<a href='/tweet/"
                    + mainTweet.id + "'>View</a> | " + "<a class='retweetBtn'href='/tweet/" + tweetValue.id + "/retweet/'>Retweet</a>"
                    + " | <a href='#' class='tweet-like' data-id=" + tweetValue.id + ">Like</a></div></div><hr>";
            } else {
                // new tweet
                tweetFormattedHtml = "<div class=\"media\"><div class=\"media-body\">" + tweetContent +
                    "<br> via <a href='" + tweetUser.url + "'>" + tweetUser.username + " </a> | " + dateDisplay + " | "
                    + "<a href='/tweet/" + tweetValue.id + "'>View</a> | " + "<a class='retweetBtn' href='/tweet/" +
                    tweetValue.id + "/retweet/'>Retweet</a>" + " | <a href='#' class='tweet-like' data-id=" + tweetValue.id + ">Like</a></div></div><hr>";
            }

            if (prepend == true) {
                tweetContainer.prepend(tweetFormattedHtml);
            } else {
                tweetContainer.append(tweetFormattedHtml);
            }
        }

        function parseTweets() {
            if (tweetList == 0) {
                tweetContainer.text('No tweets currently found')
            } else {
                $.each(tweetList, function (key, value) {
                    var tweetKey = key;
                    if (value.parent) {
                        attachTweet(value, false, true)
                    } else {
                        attachTweet(value)
                    }
                })
            }
        }

        function fetchTweets(url) {
            var fetchUrl;
            if (!url) {
                fetchUrl = initialUrl
            } else {
                fetchUrl = url
            }
            $.ajax({
                url: fetchUrl,
                data: {
                    'q': query
                },
                method: 'GET',
                success: function (data) {
                    tweetList = data.results;
                    if (data.next) {
                        nextTweetUrl = data.next;
                    } else {
                        $("#loadmore").css('display', 'none')
                    }
                    parseTweets();
                    updateHashLinks();
                },
                error: function (data) {
                    console.log('Error');
                    console.log(data)
                }
            });
        }

        fetchTweets();

        $("#loadmore").click(function (event) {
            event.preventDefault();
            if (nextTweetUrl) {
                fetchTweets(nextTweetUrl)
            }
        });

        var charsStart = 140;
        var charsCurrent = 0;
        $("#tweet-form").append("<span id='tweetCharsLeft'>" + charsStart + "</span>");

        $("#tweet-form textarea").keyup(function (event) {
            var tweetValue = $(this).val();
            charsCurrent = charsStart - tweetValue.length;
            var spanChars = $("#tweetCharsLeft");
            spanChars.text(charsCurrent);

            if (charsCurrent > 0) {
                spanChars.removeClass('grey-color');
                spanChars.removeClass('red-color');
            } else if (charsCurrent == 0) {
                spanChars.removeClass('red-color');
                spanChars.addClass('grey-color');
            } else if (charsCurrent < 0) {
                spanChars.removeClass('grey-color');
                spanChars.addClass('red-color');

            }
        });

        $("#tweet-form").submit(function (event) {
            event.preventDefault();
            var this_ = $(this);
            var formData = this_.serialize();
            if (charsCurrent >= 0) {
                $.ajax({
                    url: '/api/tweet/create/',
                    data: formData,
                    method: 'POST',
                    success: function (data) {
                        this_.find('input[type=text], textarea').val('');
                        attachTweet(data, true);
                        updateHashLinks();
                    },
                    error: function (data) {
                        console.log('Error');
                        console.log(data.statusText);
                        console.log(data.status);
                    }
                })
            } else {
                console.log('Cannot send, tweet too long')
            }
        });
    }
</script>
{% block script %}
{% endblock %}
<script src="{% static 'static/js/bootstrap.min.js' %}"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</body>
</html>